# 賽博琴仙 (Cyber Qin)

**用真實鋼琴彈奏，遊戲角色同步演奏。**

[![CI](https://github.com/EdmondVirelle/cyber-qin/actions/workflows/ci.yml/badge.svg)](https://github.com/EdmondVirelle/cyber-qin/actions/workflows/ci.yml)
![Python 3.11+](https://img.shields.io/badge/Python-3.11%2B-blue)
![Platform](https://img.shields.io/badge/Platform-Windows-0078D6)
![Version](https://img.shields.io/badge/Version-2.3.1-green)
![Tests](https://img.shields.io/badge/Tests-1241%20passed-brightgreen)

[English Version](README.md)

---

## 目錄

- [簡介](#簡介)
- [快速開始](#快速開始)
- [下載與安裝](#下載與安裝)
- [功能指南](#功能指南)
  - [即時演奏模式](#1-即時演奏模式-live-mode)
  - [曲庫](#2-曲庫-library)
  - [編曲器](#3-編曲器-sequencer)
  - [練習模式](#4-練習模式-practice-mode)
- [鍵位方案](#鍵位方案)
- [鍵盤快捷鍵](#鍵盤快捷鍵)
- [設定與配置](#設定與配置)
- [智慧前處理管線](#智慧前處理管線)
- [MIDI 效果器](#midi-效果器-fx)
- [AI 旋律生成器](#ai-旋律生成器)
- [多格式匯入匯出](#多格式匯入匯出)
- [系統架構](#系統架構)
- [常見問題排解](#常見問題排解)
- [開發指南](#開發指南)
- [技術棧](#技術棧)
- [致謝](#致謝)
- [免責聲明](#免責聲明)

---

## 簡介

**賽博琴仙** 是一款專業級的即時 MIDI 轉鍵盤映射工具，專為遊戲內音樂演奏設計。它將 USB MIDI 鍵盤的訊號轉換成 DirectInput 掃描碼，延遲 **< 2ms**，讓遊戲角色完美同步你的真實演奏。

從最初的簡單按鍵映射器，賽博琴仙已進化為完整的**數位音樂工作站**——整合多軌 MIDI 編輯器、智慧編排算法、MIDI 效果處理、AI 輔助作曲、節奏遊戲風格練習模式，以及多格式匯入匯出。

### 支援遊戲

| 遊戲 | 鍵數 | 方案 ID |
|------|------|---------|
| **燕雲十六聲** (Where Winds Meet) | 36 | `wwm_36` |
| **Final Fantasy XIV** (FF14) | 37 | `ff14_37` |
| **其他遊戲** | 24 / 48 / 88 | `generic_24` / `generic_48` / `generic_88` |

### 介面語言

整個 UI 支援 5 種語言，可隨時透過左下角語言選擇器切換：

- English（英文）
- 繁體中文
- 简体中文
- 日本語（日文）
- 한국어（韓文）

---

## 快速開始

1. **下載** 最新版 ZIP 檔，來自 [GitHub Releases](https://github.com/EdmondVirelle/cyber-qin/releases)
2. **解壓縮** 請使用 [7-Zip](https://www.7-zip.org/)（Windows 內建解壓縮工具對中文路徑可能失敗）
3. **執行** `賽博琴仙.exe` — 會自動要求系統管理員權限
4. **連接** USB MIDI 鍵盤
5. **選擇** 在即時演奏模式的下拉選單中選擇你的 MIDI 裝置
6. **設定** 選擇對應遊戲的鍵位方案（如「燕雲十六聲 36鍵」）
7. **切換** 到遊戲視窗開始演奏

> **重要**：程式**必須**以系統管理員身分執行。若無提升權限，`SendInput`（Windows 用於按鍵注入的 API）會靜默失敗——MIDI 鍵盤在程式中看起來正常運作，但不會有按鍵送到遊戲。打包後的 `.exe` 會自動觸發 UAC 提升。

---

## 下載與安裝

### 方案 A：預編譯執行檔（推薦）

1. 前往 [GitHub Releases](https://github.com/EdmondVirelle/cyber-qin/releases)
2. 下載最新的 `賽博琴仙-v*.zip`
3. **用 7-Zip 解壓縮** — Windows 內建解壓縮工具常常失敗，因為資料夾名稱「賽博琴仙」包含中文字。7-Zip 能正確處理 Unicode 路徑。
4. 執行 `賽博琴仙.exe`

> **Windows Defender 可能會標記此執行檔**，因為它沒有商業程式碼簽章。這是誤報。你可以將資料夾加入 Windows Defender 排除清單，或者從原始碼自行編譯。

### 方案 B：從原始碼安裝

#### 系統需求

- **作業系統**：Windows 10 / 11（64 位元）
- **Python**：3.11、3.12 或 3.13
- **MIDI 裝置**：任何 USB MIDI 鍵盤（已測試 Roland FP-30X）
- **權限**：系統管理員（`SendInput` 必需）

> **請勿使用 Python 3.14 alpha** — PyQt6 在匯入時會致命崩潰，錯誤訊息為「Unable to embed qt.conf」。這是已知的 PyQt6 不相容問題。

#### 安裝步驟

```bash
# 1. 複製專案
git clone https://github.com/EdmondVirelle/cyber-qin.git
cd cyber-qin

# 2. 建立虛擬環境（推薦 Python 3.11）
python -m venv .venv
.venv\Scripts\activate

# 3. 安裝（含開發依賴）
pip install -e .[dev]

# 4. 執行（必須在管理員終端中）
cyber-qin
# 或：python -m cyber_qin
```

### 方案 C：自行編譯執行檔

```bash
# 一鍵打包腳本（自動偵測 Python 3.13、建立 venv、打包）
python scripts/build.py

# 輸出：dist/賽博琴仙/賽博琴仙.exe（約 95 MB）
```

打包腳本會：
1. 在系統中搜尋 Python 3.13
2. 建立 `.venv313/` 虛擬環境
3. 安裝所有依賴
4. 產生應用程式圖示
5. 執行 PyInstaller
6. 選擇性以自簽憑證簽署執行檔

> **打包必須使用 Python 3.13** — 不能用 3.11 或 3.12。因為 PyInstaller spec 檔案是為 3.13 相容性而配置的。

---

## 功能指南

### 1. 即時演奏模式 (Live Mode)

即時演奏是核心功能——延遲低於 2ms 的 MIDI 轉鍵盤即時轉換。

#### 運作原理

```
MIDI 鍵盤 → USB → python-rtmidi（C++ 執行緒）→ KeyMapper → SendInput（掃描碼）→ 遊戲
```

按鍵注入**直接在 rtmidi 回調執行緒**上執行（不經過 Qt 事件佇列），這是達到 < 2ms 延遲的關鍵。若透過 Qt 信號傳遞會額外增加約 20ms。

#### 操作控制

| 控制項 | 說明 |
|--------|------|
| **MIDI 裝置**下拉選單 | 選擇已連接的 MIDI 鍵盤。每 5 秒自動刷新。 |
| **鍵位方案**下拉選單 | 選擇遊戲對應的按鍵配置（見[鍵位方案](#鍵位方案)）。 |
| **移調**微調器 | 將所有音符上/下移指定半音數。當曲目的調性超出遊戲可用範圍時很有用。 |
| **查看映射**按鈕 | 開啟唯讀對話框，顯示完整的 MIDI 音符 → 鍵盤按鍵對照表。 |
| **自動調音**開關 | 啟用錄音後的量化與音高校正。 |

#### 常見卡關點

- **「我接了 MIDI 鍵盤但遊戲裡沒反應」**
  - 確認是否以系統管理員身分執行。沒有管理員權限，`SendInput` 會靜默失敗。
  - 確認鍵位方案——如果遊戲用 36 鍵但你選了 88 鍵方案，超出範圍的音符不會映射。
  - 確認彈奏時遊戲視窗是前景焦點。`SendInput` 會送到最前方的視窗。

- **「有些音符在遊戲裡沒觸發」**
  - 那些音符超出鍵位方案的 MIDI 範圍。使用**移調**將它們移入範圍，或啟用智慧前處理（會自動移調）。
  - 確認你的鍵盤輸入法（IME）是否啟動——中文/日文輸入法可能攔截按鍵事件。程式會偵測並顯示警告。

- **「有明顯延遲」**
  - 關閉可能佔用 MIDI 埠的 DAW 軟體。
  - 確保使用 **USB** 連接，不是藍牙 MIDI（藍牙會額外增加 10-20ms 延遲）。

#### 自動化功能

| 功能 | 行為 |
|------|------|
| **熱插拔偵測** | 每 5 秒掃描新增/移除的 MIDI 裝置，並記錄變更。 |
| **自動重連** | MIDI 裝置斷線後，每 3 秒嘗試重新連接。 |
| **防卡鍵看門狗** | 偵測到按鍵按住超過 10 秒（可能是卡鍵），自動釋放。 |
| **偏好裝置** | 在設定（`Ctrl+,`）中設定。程式啟動時會優先連接此裝置。 |

#### 88 鍵鋼琴顯示器

即時演奏模式底部有一個即時 88 鍵鋼琴視覺化。正在按下的音符會以方案顏色發光。即使還沒切換到遊戲，也能確認 MIDI 輸入是否正常接收。

---

### 2. 曲庫 (Library)

曲庫管理你的 MIDI 檔案收藏，並提供自動播放功能。

#### 匯入 MIDI 檔案

- 點擊**匯入**按鈕，或**拖放** `.mid` / `.midi` 檔案到曲庫
- 檔案會立即解析——詮釋資料（BPM、時長、音符數、軌道數）會被擷取並顯示
- 曲庫會記住你上次匯入的目錄

#### 曲目列表

每首曲目顯示：
- **名稱**（來自檔案名或 MIDI 詮釋資料）
- **BPM**（從 MIDI 速度事件偵測）
- **音符數量**
- **時長**

**排序**：點擊欄位標題可依名稱 / BPM / 音符數 / 時長排序。可切換升序/降序。

**搜尋**：在搜尋列輸入關鍵字即可依名稱過濾曲目。

#### 播放控制

| 控制項 | 說明 |
|--------|------|
| **播放 / 暫停 / 停止** | 標準播放控制。 |
| **速度**滑桿 | 0.25x 到 2.0x 播放速度。滑桿在底部的播放控制列。 |
| **循環**開關 | 無限重複播放當前曲目。 |
| **節拍器倒數** | 播放前選擇性 4 拍倒數。讓你有時間切換到遊戲視窗。 |
| **進度條** | 拖曳跳轉到曲目的任何位置。 |

#### 右鍵選單

在曲庫中右鍵點擊曲目可以：
- **播放** — 開始播放
- **在編曲器中編輯** — 在 MIDI 編輯器中開啟
- **練習** — 載入練習模式
- **詮釋資料** — 檢視詳細 MIDI 檔案資訊
- **移除** — 從曲庫移除（不會刪除原始檔案）

#### 常見卡關點

- **「播放太快或太慢」**
  - 檢查底部播放控制列的速度滑桿。可能被設定成非 1.0x。

- **「播放時有些音符消失了」**
  - 智慧前處理管線會自動移調和摺疊音符到方案的範圍內。完全無法映射的音符會被靜默丟棄。可在日誌查看器中查看前處理統計。

- **「喇叭有聲音但遊戲沒反應」**
  - 音訊預覽（透過 Windows GS Wavetable Synth）與按鍵注入是分開的。確認播放時遊戲視窗是前景焦點。

---

### 3. 編曲器 (Sequencer)

完整的鋼琴卷簾 MIDI 編輯器，用於創作和編輯音樂編排。

#### 編輯器配置

```
┌──────────────────────────────────────────────────────────┐
│ 工具列：[新建] [開啟] [儲存] [復原] [重做] [FX] [生成]     │
│         [播放] [停止] [循環] [節拍器] [速度]               │
├────────┬─────────────────────────────────────────────────┤
│ 音高   │            鋼琴卷簾                               │
│ 尺標   │  ┌──────────────────────────────────────────┐   │
│(C0-C8) │  │  ████  ██  ████████████  ██ ██          │   │
│        │  │      ██████      ████        ██████      │   │
│        │  │  ██  ██    ████  ██  ████    ██          │   │
│        │  └──────────────────────────────────────────┘   │
├────────┴─────────────────────────────────────────────────┤
│ 軌道面板：[軌道 1 ♪] [軌道 2 ♪] [軌道 3 ♪] [+]           │
└──────────────────────────────────────────────────────────┘
```

#### 編輯操作

| 動作 | 方法 |
|------|------|
| **繪製音符** | 在鋼琴卷簾上點擊指定位置和音高 |
| **選取音符** | 點擊單一音符，或拖曳選取多個 |
| **移動音符** | 拖曳已選取的音符到新位置 |
| **調整長度** | 拖曳音符的右邊緣來改變持續時間 |
| **刪除音符** | 選取後按 `Delete`，或右鍵 → 刪除 |
| **復原 / 重做** | `Ctrl+Z` / `Ctrl+Y`（最多 100 層） |

#### 多軌支援

- 最多建立 12 個軌道，每軌有獨立顏色和 MIDI 通道
- 可**靜音** / **獨奏**個別軌道
- 軌道顏色來自預定義的 Cyber-Ink 調色盤（12 色）
- 匯出為 Type 1（多軌）MIDI 檔案

#### 幽靈音符

執行智慧編排後，原始音符位置會以半透明珊瑚紅色的「幽靈音符」顯示。幫助你看到編排算法做了哪些改變。用 **Ghost** 按鈕切換，用滑桿調整透明度。

#### 自動化曲線

繪製**力度**和**速度**的自動化曲線：
- 點擊新增控制點
- 拖曳調整數值
- 雙擊刪除控制點
- 控制點之間線性內插
- 與鋼琴卷簾水平同步捲動

#### 常見卡關點

- **「按播放沒有聲音」**
  - 編輯器透過系統 MIDI 合成器（Windows GS Wavetable Synth）播放。確認系統音量沒有靜音。如果沒有可用的 MIDI 輸出埠，播放會靜音但游標仍會移動。

- **「復原好像沒用」**
  - 復原最多 100 層。每個操作都會記錄描述（在狀態列可見）。超過 100 次操作後，最早的記錄會被丟棄。

- **「匯出的 MIDI 在 DAW 裡聽起來不同」**
  - 編輯器匯出標準 Type 1 MIDI。然而智慧編排管線可能已移調或摺疊音符。如需原始音高，請匯出未編排的版本。

---

### 4. 練習模式 (Practice Mode)

節奏遊戲風格的練習系統——音符從上方落下，在到達判定線時按下對應按鍵。

#### 如何進入練習模式

**方法 A**：點擊側邊欄的「練習」→ 使用內建選曲器：
- 點擊 **「開啟 MIDI 檔案...」** 載入任何 `.mid` 檔案
- 或從下方的**曲庫曲目**列表中選擇

**方法 B**：在曲庫中右鍵點擊曲目 → 選擇**「練習」**

#### 遊玩方式

```
     ↓ ↓ ↓ ↓ ↓     （音符落下）
     ↓ ↓ ↓ ↓ ↓
═══════════════════  （金色判定線）
     PERFECT!        （命中回饋）
```

音符從螢幕頂部以與曲目 BPM 成正比的速度落下。當音符到達金色線時，在 MIDI 鍵盤上按下對應的鍵（或使用鍵盤輸入模式）。

#### 計分系統

| 等級 | 時間窗口 | 分數 | 視覺效果 |
|------|---------|------|---------|
| **PERFECT** | ±30 ms | 300 | 金色閃光 |
| **GREAT** | ±80 ms | 200 | 綠色閃光 |
| **GOOD** | ±150 ms | 100 | 藍色閃光 |
| **MISS** | > ±150 ms | 0 | 紅色閃光 |

**顯示的數據**：分數、準確率 %、連擊數、最高連擊

#### 輸入模式

| 模式 | 說明 |
|------|------|
| **MIDI** | 使用已連接的 MIDI 鍵盤。音高必須完全匹配。 |
| **鍵盤** | 使用電腦鍵盤。按鍵依照選定的方案映射。 |

#### 選曲器（空狀態頁面）

首次開啟練習模式時，你會看到**選曲器**頁面：
- 音符圖示和標題「選擇練習曲目」
- **「開啟 MIDI 檔案...」** 按鈕 — 開啟檔案對話框
- **「曲庫曲目」** 區段 — 顯示曲庫中所有曲目的可點擊卡片
- 每張卡片顯示曲名、時長和音符數
- 點擊任何卡片即可立即開始練習該曲目

開始練習後，點擊標題列的**「換曲」**按鈕可返回選曲器。

#### 常見卡關點

- **「點擊曲目卡片沒反應」**
  - 這是 v2.3.0 的 bug（已在 v2.3.1 修復）。請更新到最新版本。

- **「音符掉太快/太慢」**
  - 落下速度與曲目 BPM 連動。練習模式目前沒有手動速度調整——可先在曲庫中以不同速度播放，再切換到練習模式。

- **「曲庫曲目區顯示『曲庫為空』」**
  - 請先在曲庫分頁匯入 MIDI 檔案。練習模式的選曲器會鏡像曲庫的曲目列表。

---

## 鍵位方案

五個內建方案涵蓋不同遊戲和鍵數：

### 燕雲十六聲 36 鍵

| 列 | 修飾鍵 | 按鍵 | MIDI 範圍 |
|----|--------|------|-----------|
| 下排 | 無 | Z X C V B N M , . / ; ' | C3 – B3 |
| 中排 | 無 | A S D F G H J K L | C4 – B4 |
| 上排 | 無 | Q W E R T Y U I O P [ ] | C5 – B5 |

升降記號使用 **Shift** 和 **Ctrl** 修飾鍵搭配相同按鍵。

### FF14 37 鍵

針對 Final Fantasy XIV 吟遊詩人演奏系統優化的全音階配置。使用數字列、QWER 列、ASDF 列。Ctrl 修飾鍵用於升降記號。

### 通用 24 / 48 / 88 鍵

適用於其他遊戲或通用用途的可擴展配置。88 鍵方案覆蓋完整鋼琴範圍（A0–C8），使用 8 層 Shift/Ctrl 修飾鍵組合。

#### 切換方案

在即時演奏模式或編曲器工具列的下拉選單中選擇方案。方案會影響：
- 哪些 MIDI 音符映射到哪些鍵盤按鍵
- 鋼琴顯示器上高亮的範圍
- 前處理管線的目標範圍

---

## 鍵盤快捷鍵

### 全域

| 快捷鍵 | 動作 |
|--------|------|
| `Ctrl+,` | 開啟設定對話框 |
| `Ctrl+Q` | 關閉程式 |

### 編曲器

| 快捷鍵 | 動作 |
|--------|------|
| `Ctrl+Z` | 復原 |
| `Ctrl+Y` | 重做 |
| `Ctrl+S` | 儲存專案 |
| `Ctrl+O` | 開啟專案 |
| `Ctrl+N` | 新建專案 |
| `Space` | 播放 / 暫停 |
| `Escape` | 停止 |
| `L` | 切換循環 |
| `M` | 切換節拍器倒數 |
| `Delete` | 刪除選取的音符 |
| `Ctrl+A` | 全選音符 |
| `Ctrl+E` | 匯出 MIDI |

### 曲庫

| 快捷鍵 | 動作 |
|--------|------|
| `Space` | 播放 / 暫停選取的曲目 |
| `Escape` | 停止播放 |

---

## 設定與配置

按 `Ctrl+,` 或點擊側邊欄齒輪圖示開啟設定。

### MIDI 分頁

| 設定項 | 說明 | 注意事項 |
|--------|------|---------|
| **偏好裝置** | 啟動時自動連接此裝置 | 必須與下拉選單中顯示的裝置名稱完全一致 |
| **自動連接** | 找到偏好裝置時自動連接 | 如果有多個 MIDI 裝置且想手動控制，請停用 |

### 播放分頁

| 設定項 | 說明 |
|--------|------|
| **預設方案** | 預設使用的鍵位方案 |
| **預設移調** | 套用到所有播放的半音偏移 |

### 編輯器分頁

| 設定項 | 說明 |
|--------|------|
| **吸附網格** | 啟用/停用鋼琴卷簾的音符吸附 |
| **網格細分** | 1/4、1/8、1/16 音符網格 |
| **自動儲存** | 定期自動儲存編輯器狀態 |
| **自動儲存間隔** | 自動儲存頻率（預設：60 秒） |

### UI 分頁

| 設定項 | 說明 |
|--------|------|
| **語言** | UI 語言（自動偵測或手動選擇） |
| **主題** | 目前僅支援「墨韻賽博」（暗色主題） |

### 配置檔案

設定以 JSON 格式儲存在 `%USERPROFILE%\.cyber_qin\config.json`。此檔案可讀，需要時可手動編輯。

自動儲存資料存放在 `%USERPROFILE%\.cyber_qin\autosave.cqp`（gzip 壓縮的 JSON）。

---

## 智慧前處理管線

載入 MIDI 檔案播放時，會通過 9 階段前處理管線：

| 階段 | 作用 | 原因 |
|------|------|------|
| 1. **打擊樂過濾** | 移除 GM 通道 10（鼓組） | 遊戲沒有鼓鍵 |
| 2. **軌道過濾** | 僅保留選取的軌道 | 專注旋律，跳過伴奏 |
| 3. **八度去重** | 同時間同音名 → 保留最高 | 減少多餘按鍵 |
| 4. **智慧全局移調** | 自動 ±12 半音移位 | 最大化方案範圍內的音符數 |
| 5. **流水摺疊** | 聲部導向的八度轉位 | 避免突兀的八度跳躍；以指數移動平均作為「重力中心」 |
| 6. **碰撞去重** | 力度優先的重複移除 | 防止同鍵雙觸發 |
| 7. **複音限制器** | 限制同時發聲音符數 | 某些遊戲限制複音數 |
| 8. **力度正規化** | 所有力度 → 127 | 遊戲不響應力度 |
| 9. **時間量化** | 對齊到 60 FPS 網格（約 16.67ms） | 配合遊戲的輸入輪詢頻率 |

前處理後可查看 `PreprocessStats` 摘要，顯示多少音符被移位、移除或摺疊。

---

## MIDI 效果器 (FX)

編曲器包含四種即時 MIDI 效果，可透過工具列的 **FX** 按鈕存取：

### 琶音器 (Arpeggiator)

將和弦展開為連續音符序列。

| 參數 | 選項 |
|------|------|
| **模式** | 上行、下行、上下行、隨機 |
| **速率** | 音符細分（1/4、1/8、1/16） |
| **八度範圍** | 跨越的八度數 |

### 人性化 (Humanize)

加入微妙隨機變化，模擬真人演奏。

| 參數 | 範圍 |
|------|------|
| **時間抖動** | 0–50 ms 隨機偏移 |
| **力度抖動** | 0–30 隨機力度變化 |
| **種子值** | 確定性隨機，可重現結果 |

### 量化 (Quantize)

將音符對齊到最近的節拍網格。

| 參數 | 選項 |
|------|------|
| **網格** | 四分音符、八分音符、十六分音符、八分三連音 |
| **強度** | 0.0（不變）– 1.0（完全對齊） |

### 和弦生成 (Chord Generator)

從單音生成和弦。

| 參數 | 選項 |
|------|------|
| **和弦類型** | 大調、小調、七和弦、大七、小七、減和弦、增和弦、掛二、掛四、強力和弦 |
| **聲位** | 密集、開放、Drop-2 |

---

## AI 旋律生成器

編曲器中的**生成**按鈕開啟旋律生成器對話框。

### 旋律生成

基於一階馬可夫鏈的規則式生成器：

| 參數 | 選項 |
|------|------|
| **音階** | 大調、小調、五聲、藍調、多利安、混合利底安、弗里吉安、利底安 |
| **調性** | C 到 B |
| **長度** | 生成的音符數量 |
| **種子值** | 確保可重現的輸出 |

生成器產生的旋律具有：
- 級進運動偏好（避免大跳）
- 樂句結構（主音/屬音收束）
- 輪廓塑形以確保音樂連貫性

### 低音線生成

根據和弦進行自動產生低音線：

| 進行 | 和弦 |
|------|------|
| I-IV-V-I | 古典 |
| I-V-vi-IV | 流行 |
| I-vi-IV-V | 50 年代 |
| ii-V-I | 爵士 |

---

## 多格式匯入匯出

### 匯入格式

| 格式 | 副檔名 | 備註 |
|------|--------|------|
| **MIDI** | `.mid`、`.midi` | 標準 MIDI 檔案（Type 0 和 Type 1） |
| **MusicXML** | `.musicxml`、`.xml` | 樂譜交換格式 |
| **ABC 記譜法** | `.abc` | 文字式民謠音樂記譜 |
| **LilyPond** | `.ly` | 樂譜排版記譜 |

### 匯出格式

| 格式 | 副檔名 | 備註 |
|------|--------|------|
| **MIDI** | `.mid` | Type 0（單軌）或 Type 1（多軌） |
| **ABC 記譜法** | `.abc` | 文字式記譜 |
| **LilyPond** | `.ly` | 用於 LilyPond 樂譜排版 |
| **WAV** | `.wav` | 透過系統 MIDI 合成器渲染音訊 |

---

## 系統架構

### 資料流 — 即時演奏

```
┌─────────────┐  USB   ┌──────────────┐  callback  ┌───────────┐  lookup  ┌──────────────┐  SendInput  ┌──────┐
│ MIDI 鍵盤   │───────→│ python-rtmidi│───────────→│ KeyMapper │─────────→│ KeySimulator │────────────→│ 遊戲 │
└─────────────┘        └──────────────┘             └───────────┘          └──────────────┘             └──────┘
                       (C++ rtmidi 執行緒)                                  (掃描碼)
```

### 資料流 — 自動播放

```
┌───────────┐  parse  ┌──────────────┐  preprocess  ┌──────────────────┐  timed events  ┌──────────────┐
│ .mid 檔案 │────────→│ MidiFileParser│────────────→│ MidiPreprocessor │──────────────→│ PlaybackWorker│
└───────────┘         └──────────────┘              └──────────────────┘               └──────┬───────┘
                                                                                              │
                                                          lookup + SendInput                   │
                                                  ┌───────────┬──────────────┐←──────────────┘
                                                  │ KeyMapper │ KeySimulator │→ 遊戲
                                                  └───────────┴──────────────┘
```

### 模組結構

```
cyber_qin/
├── core/           # 純邏輯層（不依賴 Qt）— 不需 QApplication 即可測試
│   ├── constants.py         # 掃描碼、MIDI 範圍、列舉
│   ├── key_mapper.py        # MIDI 音符 → 鍵盤按鍵映射
│   ├── key_simulator.py     # Win32 SendInput 封裝
│   ├── midi_listener.py     # 即時 MIDI 裝置擷取
│   ├── midi_file_player.py  # MIDI 檔案解析 + 播放
│   ├── midi_preprocessor.py # 9 階段事件管線
│   ├── midi_fx.py           # 4 種 MIDI 效果處理器
│   ├── melody_generator.py  # AI 旋律 + 低音生成
│   ├── smart_arrangement.py # 自動移調 + 摺疊算法
│   ├── practice_engine.py   # 計分系統（Perfect/Great/Good/Miss）
│   ├── beat_sequence.py     # 節拍時間軸 + EditorSequence
│   ├── translator.py        # 5 語言 i18n 引擎
│   ├── config.py            # JSON 設定持久化
│   └── ...                  # （共 18 個核心模組）
├── gui/            # PyQt6 UI 層
│   ├── app_shell.py         # 主視窗 + 分頁管理
│   ├── theme.py             # 墨韻賽博暗色主題（30+ 色）
│   ├── icons.py             # 21 個向量圖示（QPainter，無圖檔）
│   ├── views/               # 即時演奏、曲庫、編曲器、練習
│   ├── widgets/             # 鋼琴、側邊欄、卷簾等
│   └── dialogs/             # 設定、效果器、旋律生成器等
└── utils/          # 系統工具
    ├── admin.py             # UAC 權限檢查 + 提升
    └── ime.py               # 輸入法偵測（CJK 警告）
```

### 設計原則

1. **核心/介面分離**：`core/` 中所有模組是純 Python，零 PyQt6 依賴，可不需 QApplication 進行單元測試
2. **延遲載入 Qt 類別**：同時需要純 Python 和 Qt 類別的模組使用工廠模式，延遲 Qt 類別定義到 QApplication 建立之後（參考 `midi_file_player.py`）
3. **執行緒安全**：MIDI 回調在 C++ 執行緒上執行。絕不從此執行緒操作 Qt widget——使用 `pyqtSignal` 進行跨執行緒通訊
4. **掃描碼**：使用 DirectInput 掃描碼（`KEYEVENTF_SCANCODE`），而非虛擬鍵碼——繞過 Windows 訊息佇列的遊戲所必需

---

## 常見問題排解

### 安裝問題

| 問題 | 原因 | 解決方案 |
|------|------|---------|
| `import PyQt6.QtCore` 崩潰，訊息為 "Unable to embed qt.conf" | Python 3.14 alpha | 使用 Python 3.11、3.12 或 3.13 |
| `pip install` 安裝 `python-rtmidi` 失敗 | 缺少 C++ 編譯工具 | 安裝 [Visual C++ Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/) |
| 解壓縮失敗，資料夾名稱亂碼 | Windows 檔案總管無法處理 Unicode ZIP 路徑 | 使用 [7-Zip](https://www.7-zip.org/) 解壓縮 |

### 執行問題

| 問題 | 原因 | 解決方案 |
|------|------|---------|
| 按鍵在遊戲中不起作用 | 沒有以系統管理員執行 | 右鍵 → 「以系統管理員身分執行」，或確認 UAC 提升對話框 |
| 按鍵在遊戲中不起作用（有管理員權限） | 遊戲防作弊系統阻擋 SendInput | 這是限制；某些防作弊系統會阻擋所有外部輸入 |
| MIDI 裝置未列出 | 裝置被其他程式佔用 | 關閉 DAW 或其他 MIDI 軟體 |
| MIDI 裝置未列出 | 驅動程式問題 | 重新連接 USB，檢查裝置管理員 |
| 高延遲（> 10ms） | 使用藍牙 MIDI 轉接器 | 改用 USB 連接 |
| 高延遲（> 10ms） | 在虛擬機中執行 | 在 Windows 原生環境執行 |
| 某些音符觸發錯誤按鍵 | 選錯鍵位方案 | 選擇與遊戲相符的方案 |
| 中文/日文輸入法警告 | 啟動的 IME 攔截按鍵事件 | 演奏時將 IME 切換到英文模式 |
| `SendInput` 返回 0 | ctypes INPUT 結構體大小不符 | 這是建構 bug——請回報。INPUT 結構體必須恰好 40 bytes。 |

### 編輯器問題

| 問題 | 原因 | 解決方案 |
|------|------|---------|
| 編輯器播放沒有聲音 | 沒有 MIDI 輸出埠 | Windows GS Wavetable Synth 預設應該可用。檢查音訊設定。 |
| 有聲音但游標不動 | 播放執行緒計時問題 | 停止並重新開始播放 |
| 自動儲存沒有作用 | 設定問題 | 確認 `~/.cyber_qin/config.json` 中 `editor.auto_save` 為 `true` |

### 練習模式問題

| 問題 | 原因 | 解決方案 |
|------|------|---------|
| 點擊曲目卡片沒反應 | v2.3.0 的 bug（v2.3.1 已修復） | 更新到最新版本 |
| 選曲器顯示「曲庫為空」 | 沒有匯入曲目 | 先在曲庫分頁匯入 MIDI 檔案 |
| 音高判定有誤 | MIDI 鍵盤八度偏移 | 調整鍵盤的八度設定使其相符 |

---

## 開發指南

### 執行測試

```bash
# 全部 1241 個測試
pytest

# 詳細輸出
pytest -v

# 含覆蓋率報告
pytest --cov=cyber_qin --cov-report=html

# 僅單元測試（跳過整合 + GUI 測試）
pytest -m "not integration and not gui"

# 單一測試檔案
pytest tests/test_practice_view.py -v
```

### 程式碼檢查

```bash
ruff check .
ruff check --fix .
ruff format --check .
```

### 型別檢查

```bash
mypy cyber_qin --install-types --non-interactive
```

### 專案統計

| 指標 | 數值 |
|------|------|
| 版本 | 2.3.1 |
| 程式碼行數 | ~12,750+ LOC |
| Python 模組 | 58 |
| 測試 | 1,241 |
| 測試檔案 | 25 |
| 覆蓋率 | > 85% |
| 支援 Python | 3.11 / 3.12 / 3.13 |
| 語言 | 5（en、zh_TW、zh_CN、ja、ko） |
| i18n 翻譯鍵 | 300+ |

### CI/CD

- **CI**（`.github/workflows/ci.yml`）：每次推送/PR 到 `main` 時執行
  - 測試矩陣：3 作業系統（Ubuntu、Windows、macOS）× 3 Python 版本（3.11、3.12、3.13）
  - 程式碼風格 + 格式檢查（Ruff）
  - i18n 完整性檢查
  - 型別檢查（mypy）
  - 建構 artifact（僅 Windows，僅 main 分支）

- **Release**（`.github/workflows/release.yml`）：由 tag 推送觸發（`v*`）
  - 以 PyInstaller 建構 Windows 執行檔
  - 建立 GitHub Release 附 ZIP 下載

關於程式碼風格、測試及貢獻流程的詳細規範，請參閱 [CONTRIBUTING.md](CONTRIBUTING.md)。

---

## 技術棧

| 層級 | 技術 | 用途 |
|------|------|------|
| **MIDI I/O** | `mido` + `python-rtmidi` | USB 裝置通訊、MIDI 檔案解析 |
| **按鍵注入** | `ctypes` + Win32 `SendInput` | DirectInput 掃描碼注入（< 2ms） |
| **GUI** | PyQt6 | 桌面介面、事件迴圈、跨執行緒信號 |
| **主題** | 自訂 QSS + QPainter | 「墨韻賽博」暗色主題、21 個向量圖示、30+ 色 |
| **打包** | PyInstaller | 單資料夾執行檔（約 95 MB） |
| **CI/CD** | GitHub Actions | 9 工作矩陣測試 + 自動化發佈 |
| **靜態檢查** | Ruff | 超快速 Python linter（99 字元行寬） |
| **測試** | pytest + pytest-qt | 1,241 單元 / 整合 / GUI 測試 |
| **型別檢查** | mypy | 漸進式型別採用 |

---

## 致謝

- [mido](https://github.com/mido/mido) — Python MIDI 函式庫
- [python-rtmidi](https://github.com/SpotlightKid/python-rtmidi) — 低延遲跨平台 MIDI I/O
- [PyQt6](https://www.riverbankcomputing.com/software/pyqt/) — Python Qt 6 繫結
- [PyInstaller](https://pyinstaller.org/) — Python 應用程式打包工具
- [Ruff](https://github.com/astral-sh/ruff) — 超快速 Python linter
- *燕雲十六聲* — Where Winds Meet (Everstone Studio / NetEase)
- *Final Fantasy XIV* — FF14 (Square Enix)

---

## 免責聲明

本工具為開源個人專案，供 MIDI 音樂演奏愛好者交流學習使用。
在遊戲中使用第三方工具可能不符合該遊戲之服務條款，請使用者自行評估風險。
開發者不對因使用本工具導致的帳號處分或任何損失承擔責任。

---

**贊助**：[Ko-fi](https://ko-fi.com/virelleedmond)
